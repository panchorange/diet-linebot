%% 週次レポート配信フロー（体重・食事・運動 全観点） - SequenceDiagram
sequenceDiagram
    autonumber
    participant CRON as Weekly Scheduler
    participant WRS as WeeklyReportService
    participant DB as PostgreSQL(DB)
    participant LLM as LLM(Gemini)
    participant LC as LINE Client
    participant LINE as LINE Platform
    actor User as ユーザー

    Note over CRON: 毎週 日曜20:00（JST）に起動　または 週次レポートとユーザーが投稿

    CRON->>DB: findMany users(id, lineUserId)
    DB-->>CRON: users[]

    loop 各ユーザーごと
        Note over CRON: 週次レポート対象期間（start, end）を計算
        CRON->>CRON: start = baseTime（日曜20:00の場合は前週の日曜20:00）
        CRON->>CRON: end = baseTime（レポート送信日時）
        CRON->>WRS: generateWeeklyReport(userId, baseTime)

        %% データ取得（直近1週間）
        WRS->>DB: weight_records.findMany(userId, start..end)
        DB-->>WRS: weights[]
        WRS->>DB: meal_records.findMany(userId, start..end)
        DB-->>WRS: meals[]
        WRS->>DB: exercise_records.findMany(userId, start..end)
        DB-->>WRS: exercises[]

        %% サマリ作成
        WRS->>WRS: グラフ: 体重とBMIの推移
        WRS->>WRS: 食事サマリ: 総摂取カロリー、平均摂取カロリー、平均PFC(それぞれ)
        WRS->>WRS: 運動サマリ: 運動時間、消費カロリー、運動回数、最も多く行った運動
        WRS->>WRS: 体重サマリ: 前週からの体重増減量、開始時からの体重増減、今週の記録日数

        %% LLM解析（3観点）
        WRS->>LLM: サマリから以下を分析(体重が順調に減っているか？運動に関する良いところ、悪いところ、食事に関する良いところ、悪いところ)
        LLM-->>WRS: { message }

        %% 送信
        Note over WRS: レポートメッセージを作成(サマリ + LLMの分析結果)
        WRS-->>CRON: message
        CRON->>LC: pushMessage(lineUserId, message)
        LC-->>LINE: push
        LINE-->>User: 受信表示
    end


